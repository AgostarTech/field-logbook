{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <h2 class="dashboard-title">Supervisor Dashboard</h2>

    <!-- Search Bar & Filters -->
    <div class="top-bar">
        <input type="text" id="studentSearch" class="search-bar" placeholder="Search student by name or reg no...">
        <select id="filterCourse">
            <option value="">Filter by Course</option>
            {% for course in course_list %}
                <option value="{{ course }}">{{ course }}</option>
            {% endfor %}
        </select>
        <button id="darkModeToggle">üåô Dark Mode</button>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="card">
            <h3>Total Students</h3>
            <p>{{ students.count }}</p>
        </div>
        <div class="card">
            <h3>Pending Logs</h3>
            <p>{{ pending_logs.count }}</p>
        </div>
        <div class="card">
            <h3>Approved Logs</h3>
            <p>{{ approved_logs.count }}</p>
        </div>
        <div class="card">
            <h3>Overdue Logs</h3>
            <p>{{ overdue_logs.count }}</p>
        </div>
    </div>

    <!-- Recent Log Activity -->
    <div class="sidebar-activity">
        <h4>Recent Log Submissions</h4>
        <ul>
            {% for log in recent_logs %}
                <li>{{ log.student.user.get_full_name }} submitted log at {{ log.date|time:"H:i" }}</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Assigned Students -->
    <div class="table-container" id="studentTable">
        <h3>Assigned Students</h3>
        <table>
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Reg. No</th>
                    <th>Course</th>
                    <th>Progress</th>
                    <th>Task Status</th>
                    <th>Upload File</th>
                    <th>Assign Task</th>
                    <th>File History</th>
                </tr>
            </thead>
            <tbody id="studentBody">
                {% for student in students %}
                <tr>
                    <td>{{ student.user.get_full_name }}</td>
                    <td>{{ student.registration_number }}</td>
                    <td>{{ student.course }}</td>
                    <td>
                        <div class="progress-bar">
                            <div class="progress" style="width: {{ student.progress }}%"></div>
                        </div>
                        <small>{{ student.progress }}%</small>
                    </td>
                    <td>
                        {% if student.task and not student.task.completed %}
                            <span class="badge pending">Pending</span>
                        {% elif student.task and student.task.completed %}
                            <span class="badge completed">Completed</span>
                        {% else %}
                            <span class="badge none">No Task</span>
                        {% endif %}
                    </td>
                    <td>
                        <form method="post" enctype="multipart/form-data" action="{% url 'upload_file' student.user.id %}">
                            {% csrf_token %}
                            <input type="file" name="file" required>
                            <button type="submit">Upload</button>
                        </form>
                    </td>
                    <td>
                        <button class="btn assign-btn" data-student="{{ student.user.id }}">Assign</button>
                    </td>
                    <td>
                        <a href="{% url 'student_file_history' student.user.id %}" class="btn small">View</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pending Logs Table -->
    <div class="table-container">
        <h3>Pending Logs</h3>
        <table>
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Log Content</th>
                    <th>Date</th>
                    <th>Approve</th>
                    <th>Reject</th>
                </tr>
            </thead>
            <tbody>
                {% for log in pending_logs %}
                <tr class="{% if log.date < log.student.expected_submission_date %}overdue-log{% endif %}">
                    <td>{{ log.student.user.get_full_name }}</td>
                    <td><a href="#" class="view-log" data-log="{{ log.content }}">{{ log.content|truncatechars:50 }}</a></td>
                    <td>{{ log.date|date:"Y-m-d H:i" }}</td>
                    <td>
                        <form method="post" action="{% url 'approve_log' log.id %}">
                            {% csrf_token %}
                            <button type="submit">‚úÖ</button>
                        </form>
                    </td>
                    <td>
                        <form method="post" action="{% url 'reject_log' log.id %}">
                            {% csrf_token %}
                            <button type="submit">‚ùå</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Approved Logs -->
    <div class="table-container">
        <h3>Approved Logs</h3>
        <table>
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Log Content</th>
                    <th>Date</th>
                    <th>Approved By</th>
                </tr>
            </thead>
            <tbody>
                {% for log in approved_logs %}
                <tr>
                    <td>{{ log.student.user.get_full_name }}</td>
                    <td>{{ log.content|truncatechars:50 }}</td>
                    <td>{{ log.date|date:"Y-m-d H:i" }}</td>
                    <td>{{ log.approved_by.get_full_name }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Bulk Task Assignment -->
    <div class="bulk-task">
        <h3>Assign Bulk Task</h3>
        <form method="post" action="{% url 'bulk_assign_task' %}">
            {% csrf_token %}
            <textarea name="task" placeholder="Enter task details..." required></textarea>
            <button type="submit">Assign to All</button>
        </form>
    </div>
</div>

<!-- Task Modal -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <span id="closeModal" class="close">&times;</span>
        <h3>Assign Task</h3>
        <form id="taskForm" method="post">
            {% csrf_token %}
            <textarea name="task_description" required></textarea>
            <input type="hidden" name="student_id" id="modalStudentId">
            <button type="submit">Assign</button>
        </form>
    </div>
</div>

<!-- View Log Modal -->
<div id="logModal" class="modal">
    <div class="modal-content">
        <span id="closeLogModal" class="close">&times;</span>
        <h3>Log Details</h3>
        <p id="logContent"></p>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/supervisor_dashboard.css' %}">
<style>
    .dark-mode { background-color: #121212; color: #eee; }
    .overdue-log { background-color: #ffe6e6; }
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; }
    .pending { background: orange; color: white; }
    .completed { background: green; color: white; }
    .none { background: gray; color: white; }
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/supervisor_dashboard.js' %}"></script>
<script>
    document.getElementById('darkModeToggle').onclick = function() {
        document.body.classList.toggle('dark-mode');
    };

    document.querySelectorAll('.view-log').forEach(link => {
        link.onclick = function() {
            document.getElementById('logContent').textContent = this.dataset.log;
            document.getElementById('logModal').style.display = 'block';
        };
    });

    document.getElementById('closeLogModal').onclick = function() {
        document.getElementById('logModal').style.display = 'none';
    };
</script>
{% endblock %}
